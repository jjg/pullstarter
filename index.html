<!doctype html>
  <head>
    <meta charset="utf-8">
    <title>Pullstarter</title>
    <meta name="description" content="My Parse App">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.9.1/themes/dot-luv/jquery-ui.css">
    <script src="http://code.jquery.com/jquery-1.8.2.js"></script>
    <script src="http://code.jquery.com/ui/1.9.1/jquery-ui.js"></script>
    
    <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.1.8.min.js"></script>
    <script>

      // init Parse
      Parse.initialize("sGF4JuqzcDyl4TDKKt3U7d3OdPNZG0FZ3TqTuJTr", "OXrMKIkKStgssmijppy8fbfutIvEvUaUOn0dHIwI");

      var Idea = Parse.Object.extend("Idea");
      var user = Parse.User.current();

      $(document).ready(function() {
        $("#tabs").tabs();
        $("#allideas").accordion();
        $("#faq").accordion();
        $("#login").dialog({ autoOpen: false });
        $("#newidea").dialog({ autoOpen: false });
        $("#shownewidea").click(function() {
          $("#newidea").dialog( "open" );
        });
        $("#ideadetail").dialog({ autoOpen: false });
        $("#opener").click(function() {
          $("#ideadetails").dialog( "open" );
        });

        loadIdeas();
        loadFollwedIdeas();
        loadUserIdeas();
        loadBids();
      });

      function loadIdeas(){

        // load & display existing ideas
        var ideaQuery = new Parse.Query(Idea);
        ideaQuery.include("user");
        //ideaQuery.include("bid");
        ideaQuery.find({
          success: function(results){

            // display list
            $.each(results, function(key, value){
              ideaQuery.get(value.id, {
                success: function(idea){

                  bidTotal = 0;
                  var Bid = Parse.Object.extend("Bid");
                  var bidQuery = new Parse.Query(Bid);
                  bidQuery.equalTo("idea", idea);
                  bidQuery.find({
                    success: function(bid) {
                      //console.log(bid[0].get("amount"));
                      //bidTotal = bidTotal + bid[0].get("amount");
                    }
                  });

                  try{
                    $("#allideas").append("<h3 onclick=\"loadIdea('" + idea.id + "')\">" + idea.get("title") + "</h3>");
                    $("#allideas").append("<div>" + " $" + bidTotal + " <i>by</i> " + idea.get("user").get("username") + "<button onclick=\"followIdea('" + idea.id + "')\">follow</button></div>");
                  } catch(ex) {
                    console.log(ex);
                  }
                },
              error: function(object, error){
                  console.log(error);
                }
              });
            });
            //$("#allideas").accordion("refresh");            
          },
          error: function(error){
            console.log("Error loading ideas: " + error.code + " " + error.message);
          }
        });
      }

      function loadBids(){
        var Bid = Parse.Object.extend("Bid");
        var bidQuery = new Parse.Query(Bid);
        bidQuery.equalTo("user", user);
        bidQuery.include("idea");
        bidQuery.include("idea.user");
        bidQuery.find({
          success: function(results){

            // display list
            $.each(results, function(key, value){
              //console.log(value);
              bidQuery.get(value.id, {
                success: function(bid){
                  console.log(bid.get("amount"));
                  try{
                    $("#userbidlist").append("<li onclick=\"loadIdea('" + bid.get("idea").get("id") + "')\">" + bid.get("idea").get("title") + " $" + bid.get("amount") + " <i>by</i> " + bid.get("idea").get("user").get("username"));
                  } catch(ex) {
                    console.log(ex);
                  }
                },
                error: function(object, error){
                  console.log(error);
                }
              });
            });
          },
          error: function(error){
            console.log("Error loading followed ideas: " + error.code + " " + error.message);
          }
        });
      }

      function loadUserIdeas(){
        var ideaQuery = new Parse.Query(Idea);
        ideaQuery.equalTo("user", user);
        ideaQuery.include("user");
        ideaQuery.find({
          success: function(results){

            // display list
            $.each(results, function(key, value){
              ideaQuery.get(value.id, {
                success: function(idea){
                  //console.log(idea.get("Bid"));
                  try{
                    $("#userideaslist").append("<li onclick=\"loadIdea('" + idea.id + "')\">" + idea.get("title") + " $" + idea.get("bid") + "</li>");
                  } catch(ex) {
                    console.log(ex);
                  }
                },
                error: function(object, error){
                  console.log(error);
                }
              });
            });
          },
          error: function(error){
            console.log("Error loading followed ideas: " + error.code + " " + error.message);
          }
        });
      }

      function loadFollwedIdeas(){
        var IdeaFollow = Parse.Object.extend("IdeaFollow");
        var followQuery = new Parse.Query(IdeaFollow);
        followQuery.equalTo("user", user);
        followQuery.include("idea");
        followQuery.include("idea.user");
        followQuery.find({
          success: function(results){

            // display list
            $.each(results, function(key, value){
              //console.log(value);
              followQuery.get(value.id, {
                success: function(follow){
                  //console.log(follow.get("idea").get("title"));
                  try{
                    $("#followingideaslist").append("<li onclick=\"loadIdea('" + follow.get("idea").id + "')\">" + follow.get("idea").get("title") + " $" + follow.get("idea").get("bid") + " <i>by</i> " + follow.get("idea").get("user").get("username") + "<button onclick=\"unfollowIdea('" + follow.id + "')\">unfollow</button></li>");
                  } catch(ex) {
                    console.log(ex);
                  }
                },
                error: function(object, error){
                  console.log(error);
                }
              });
            });
          },
          error: function(error){
            console.log("Error loading followed ideas: " + error.code + " " + error.message);
          }
        });
      }

      function loadIdea(ideaId){

        var ideaQuery = new Parse.Query(Idea);
        ideaQuery.get(ideaId, {
          success: function(idea){
            $("#ideatitle").html(idea.get("title"));
            $("#ideadescription").html(idea.get("description"));  
            $("#detailfollowbutton").replaceWith("<button id=\"detailfollowbutton\" onclick=\"followIdea('" + idea.id + "')\">follow</button>");
            $("#detailbidbutton").replaceWith("<button id=\"detailbidbutton\" onclick=\"bidOnIdea('" + idea.id + "')\">bid</button>"); 
            $("#ideadetail").dialog("open");     
          },
          error: function(object, error){
              console.log(error);
            }
        });
      }

      function followIdea(ideaId){
        //alert("following " + ideaId);
        if(user == null){
          alert("need to log in first");
        } else {
          var ideaQuery = new Parse.Query(Idea);
          ideaQuery.get(ideaId, {
            success: function(idea){
              var IdeaFollow = Parse.Object.extend("IdeaFollow");
              var ideaFollow = new IdeaFollow();
              ideaFollow.set("idea", idea);
              ideaFollow.set("user", user);
              //ideaFollow.set("amount", $("#bidonamount").val());
              ideaFollow.save(null,{
                success: function(object){

                  // update follow list
                  $("#followingideaslist").append("<li id=\"" + ideaFollow.id + "\" onclick='loadIdea(" + idea.id + ")'>" + idea.get("title") + " <i>by</i> " + idea.get("user").get("username") + "</li>");
                },
                error: function(model, error){
                  console.log(error);
                  alert("error following idea!");
                }
              });             
            },
            error: function(object, error){
                console.log(error);
              }
          });
        }
      }

      function unfollowIdea(followId){
        var IdeaFollow = Parse.Object.extend("IdeaFollow");
        var followQuery = new Parse.Query(IdeaFollow);
        followQuery.get(followId, {
          success: function(ideaFollow){
            // delete
            ideaFollow.destroy({
              success: function(object){
                // update list
                //console.log($("#" + followId).html());

                // todo: this isn't removing them from the list...
                $("li").remove(":contains('" + followId +"')");
              },
              error: function(object, error){
                // delete failed
                console.log(error);
              }
            });
          },
          error: function(object, error){
            // follow not found?
            console.log(error);
          }
        });
      }

      function bidOnIdea(ideaId){
        if(user == null){
          alert("need to log in first");
        } else {
          var ideaQuery = new Parse.Query(Idea);
          ideaQuery.get(ideaId, {
            success: function(idea){
              var Bid = Parse.Object.extend("Bid");
              var bid = new Bid();
              bid.set("idea", idea);
              bid.set("user", user);
              bid.set("amount", $("#bidamount").val());
              bid.save(null,{
                success: function(object){
                  // all good
                },
                error: function(model, error){
                  console.log(error);
                  alert("error creating initial bid!");
                }
              });             
            },
            error: function(object, error){
                console.log(error);
              }
          });
        }
      }

      function newIdea(){
        if(user == null){
          alert("need to log in first");
        } else {
          var idea = new Idea();
          idea.set("title", $("#ideaTitle").val());
          idea.set("description", $("#ideaDescription").val());
          idea.set("user", user);
          idea.save(null,{
            success: function(object) {
              $("#allideaslist").append("<li onclick='loadIdea(" + idea.id + ")'>" + idea.get("title") + " <i>by</i> " + idea.get("user").get("username") + "</li>");
              $("#newidea").dialog("close");
            },
            error: function(model, error) {
              console.log(error);
              alert("adding idea failed (darn!)");
            }
          });

          // create the initial bid
          var Bid = Parse.Object.extend("Bid");
          var bid = new Bid();
          bid.set("idea", idea);
          bid.set("user", user);
          bid.set("amount", $("#initialbid").val());
          bid.save(null,{
            success: function(object){
              // all good
            },
            error: function(model, error){
              console.log(error);
              alert("error creating initial bid!");
            }
          });
        }
      }

      function register(){
        var user = new Parse.User();
        user.set("username", $("#username").val());
        user.set("password", $("#password").val());
        user.set("email", $("#email").val());

        user.signUp(null, {
          success: function(user){
            alert("signup sucessful!");
          },
          error: function(user, error){
            console.log(error);
            alert("signup failed!");
          }
        });
      }

      function login(){
        Parse.User.logIn($("#username").val(), $("#password").val(), {
          success: function(user){
            alert("logged-in sucessfully");
          },
          error: function(user, error){
            console.log(error);
            alert("login failed");
          }
        });
      }
    </script>
  </head>

  <body style=" font-family: Arial,sans-serif; font-size: 1.3em;background-color:gray">

    <h1>pullstarter</h1>

    <div id="tabs">
      <ul>
        <li><a href="#fragment-1"><span>All Ideas</span></a></li>
          <li><a href="#fragment-2"><span>Dashboard</span></a></li>
          <li><a href="#fragment-3"><span>F.A.Q.</span></a></li>
          <li><a href="#fragment-4"><span>HOW-TO</span></a></li>
      </ul>
      <div id="fragment-1">

        <div id="allideas">
        </div>
        <button id="shownewidea">new idea</button>

      </div>

      <div id="fragment-2">

        <div id="following">
          <h3>following</h3>
          <ul id="followingideaslist">
          </ul>
        </div>

        <div id="bidlist">
          <h3>bids</h3>
          <ul id="userbidlist">
          </ul>
        </div>

        <div id="userideas">
          <h3>my ideas</h3>
          <ul id="userideaslist">
          </ul>
        </div>
      </div>

      <div id="fragment-3">
        <h3>Frequently Asked Questions</h3>

        <div id="faq">
          <h3>Isn't this a rip-off of Kickstarter?</h3>
          <div>
            <p>No, you silly ape.
          </div>
          <h3>Isn't this a rip-off of Kickstarter?</h3>
          <div>
            <p>No, you silly ape.
          </div>
          <h3>Isn't this a rip-off of Kickstarter?</h3>
          <div>
            <p>No, you silly ape.
          </div>
        </div>
      </div>

      <div id="fragment-4">
        <h3>HOW-TO Pullstarter</h3>
      </div>

    </div>

    <div id="login" title="Login">
      <ul>
        <li>username: <input id="username"/>
        <li>password: <input id="password"/>
        <li>email: <input id="email"/>
        <li><button onclick="register()">register</button>&nbsp;<button onclick="login()">login</button>
      </ul>
    </div>

    <div id="newidea" title="New Idea">
      <ul>
        <li>title: <input id="ideaTitle"/>
        <li>description:<br><textarea id="ideaDescription"></textarea>
        <li>bid: <input id="initialbid"/>
        <li><button onclick="newIdea()">add</button>
      </ul>
    </div>

    <div id="ideadetail" title="Idea Details">
      <span id="ideatitle" style="font-weight:bold"></span>
      <p id="ideadescription"></p>
      <input id="bidamount"/>&nbsp;<button id="detailbidbutton">bid</button>&nbsp;<button id="detailfollowbutton">bid</button>
    </div>

  </body>
</html>
