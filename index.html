<!doctype html>
  <head>
    <meta charset="utf-8">
    <title>Pullstarter</title>
    <meta name="description" content="My Parse App">
    <link rel="stylesheet" href="css/styles.css">
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.1.8.min.js"></script>
    <script>

      // init Parse
      Parse.initialize("sGF4JuqzcDyl4TDKKt3U7d3OdPNZG0FZ3TqTuJTr", "OXrMKIkKStgssmijppy8fbfutIvEvUaUOn0dHIwI");

      var Idea = Parse.Object.extend("Idea");
      var user = Parse.User.current();

      $(document).ready(function() {
        loadIdeas();
        loadFollwedIdeas();
        loadUserIdeas();
      });

      function loadIdeas(){

        // load & display existing ideas
        var ideaQuery = new Parse.Query(Idea);
        ideaQuery.include("user");
        ideaQuery.include("bid");
        ideaQuery.find({
          success: function(results){

            // display list
            $.each(results, function(key, value){
              ideaQuery.get(value.id, {
                success: function(idea){
                  //console.log(idea.get("Bid"));
                  try{
                    $("#allideaslist").append("<li onclick=\"loadIdea('" + idea.id + "')\">" + idea.get("title") + " $" + idea.get("bid") + " <i>by</i> " + idea.get("user").get("username") + "<button onclick=\"followIdea('" + idea.id + "')\">follow</button></li>");
                  } catch(ex) {
                    console.log(ex);
                  }
                },
              error: function(object, error){
                  console.log(error);
                }
              });
            });
          },
          error: function(error){
            console.log("Error loading ideas: " + error.code + " " + error.message);
          }
        });
      }

      function loadUserIdeas(){
        var ideaQuery = new Parse.Query(Idea);
        ideaQuery.equalTo("user", user);
        ideaQuery.include("user");
        ideaQuery.find({
          success: function(results){

            // display list
            $.each(results, function(key, value){
              ideaQuery.get(value.id, {
                success: function(idea){
                  //console.log(idea.get("Bid"));
                  try{
                    $("#userideaslist").append("<li onclick=\"loadIdea('" + idea.id + "')\">" + idea.get("title") + " $" + idea.get("bid") + "</li>");
                  } catch(ex) {
                    console.log(ex);
                  }
                },
                error: function(object, error){
                  console.log(error);
                }
              });
            });
          },
          error: function(error){
            console.log("Error loading followed ideas: " + error.code + " " + error.message);
          }
        });
      }

      function loadFollwedIdeas(){
        var IdeaFollow = Parse.Object.extend("IdeaFollow");
        var followQuery = new Parse.Query(IdeaFollow);
        followQuery.equalTo("user", user);
        followQuery.include("idea");
        followQuery.include("idea.user");
        followQuery.find({
          success: function(results){

            // display list
            $.each(results, function(key, value){
              //console.log(value);
              followQuery.get(value.id, {
                success: function(follow){
                  //console.log(follow.get("idea").get("title"));
                  try{
                    $("#followingideaslist").append("<li onclick=\"loadIdea('" + follow.get("idea").id + "')\">" + follow.get("idea").get("title") + " $" + follow.get("idea").get("bid") + " <i>by</i> " + follow.get("idea").get("user").get("username") + "<button onclick=\"unfollowIdea('" + follow.id + "')\">unfollow</button></li>");
                  } catch(ex) {
                    console.log(ex);
                  }
                },
                error: function(object, error){
                  console.log(error);
                }
              });
            });
          },
          error: function(error){
            console.log("Error loading followed ideas: " + error.code + " " + error.message);
          }
        });
      }

      function loadIdea(ideaId){

        var ideaQuery = new Parse.Query(Idea);
        ideaQuery.get(ideaId, {
          success: function(idea){
            $("#ideatitle").html(idea.get("title"));
            $("#ideadescription").html(idea.get("description"));  
            $("#ideadetail").append("<button onclick=\"bidOnIdea('" + idea.id + "')\">bid</button>");      
          },
          error: function(object, error){
              console.log(error);
            }
        });
      }

      function followIdea(ideaId){
        //alert("following " + ideaId);
        if(user == null){
          alert("need to log in first");
        } else {
          var ideaQuery = new Parse.Query(Idea);
          ideaQuery.get(ideaId, {
            success: function(idea){
              var IdeaFollow = Parse.Object.extend("IdeaFollow");
              var ideaFollow = new IdeaFollow();
              ideaFollow.set("idea", idea);
              ideaFollow.set("user", user);
              //ideaFollow.set("amount", $("#bidonamount").val());
              ideaFollow.save(null,{
                success: function(object){

                  // update follow list
                  $("#followingideaslist").append("<li id=\"" + ideaFollow.id + "\" onclick='loadIdea(" + idea.id + ")'>" + idea.get("title") + " <i>by</i> " + idea.get("user").get("username") + "</li>");
                },
                error: function(model, error){
                  console.log(error);
                  alert("error following idea!");
                }
              });             
            },
            error: function(object, error){
                console.log(error);
              }
          });
        }
      }

      function unfollowIdea(followId){
        var IdeaFollow = Parse.Object.extend("IdeaFollow");
        var followQuery = new Parse.Query(IdeaFollow);
        followQuery.get(followId, {
          success: function(ideaFollow){
            // delete
            ideaFollow.destroy({
              success: function(object){
                // update list
                //console.log($("#" + followId).html());

                // todo: this isn't removing them from the list...
                $("li").remove(":contains('" + followId +"')");
              },
              error: function(object, error){
                // delete failed
                console.log(error);
              }
            });
          },
          error: function(object, error){
            // follow not found?
            console.log(error);
          }
        });
      }

      function bidOnIdea(ideaId){
        if(user == null){
          alert("need to log in first");
        } else {
          var ideaQuery = new Parse.Query(Idea);
          ideaQuery.get(ideaId, {
            success: function(idea){
              var Bid = Parse.Object.extend("Bid");
              var bid = new Bid();
              bid.set("idea", idea);
              bid.set("user", user);
              bid.set("amount", $("#bidamount").val());
              bid.save(null,{
                success: function(object){
                  // all good
                },
                error: function(model, error){
                  console.log(error);
                  alert("error creating initial bid!");
                }
              });             
            },
            error: function(object, error){
                console.log(error);
              }
          });
        }
      }

      function newIdea(){
        if(user == null){
          alert("need to log in first");
        } else {
          var idea = new Idea();
          idea.set("title", $("#ideaTitle").val());
          idea.set("description", $("#ideaDescription").val());
          idea.set("user", user);
          idea.save(null,{
            success: function(object) {
              $("#allideaslist").append("<li onclick='loadIdea(" + idea.id + ")'>" + idea.get("title") + " <i>by</i> " + idea.get("user").get("username") + "</li>");
            },
            error: function(model, error) {
              console.log(error);
              alert("adding idea failed (darn!)");
            }
          });

          // create the initial bid
          var Bid = Parse.Object.extend("Bid");
          var bid = new Bid();
          bid.set("idea", idea);
          bid.set("user", user);
          bid.set("amount", $("#initialbid").val());
          bid.save(null,{
            success: function(object){
              // all good
            },
            error: function(model, error){
              console.log(error);
              alert("error creating initial bid!");
            }
          });
        }
      }

      function register(){
        var user = new Parse.User();
        user.set("username", $("#username").val());
        user.set("password", $("#password").val());
        user.set("email", $("#email").val());

        user.signUp(null, {
          success: function(user){
            alert("signup sucessful!");
          },
          error: function(user, error){
            console.log(error);
            alert("signup failed!");
          }
        });
      }

      function login(){
        Parse.User.logIn($("#username").val(), $("#password").val(), {
          success: function(user){
            alert("logged-in sucessfully");
          },
          error: function(user, error){
            console.log(error);
            alert("login failed");
          }
        });
      }
    </script>
  </head>

  <body>

    <div id="login">
      <h3>login</h3>
      <ul>
        <li>username: <input id="username"/>
        <li>password: <input id="password"/>
        <li>email: <input id="email"/>
        <li><button onclick="register()">register</button>&nbsp;<button onclick="login()">login</button>
      </ul>
    </div>

    <div id="newidea">
      <h3>new idea</h3>
      <ul>
        <li>title: <input id="ideaTitle"/>
        <li>description:<br><textarea id="ideaDescription"></textarea>
        <li>bid: <input id="initialbid"/>
        <li><button onclick="newIdea()">add</button>
      </ul>
    </div>

    <div id="allideas">
      <h3>all ideas</h3>
      <ul id="allideaslist">
      </ul>
    </div>

    <div id="following">
      <h3>following</h3>
      <ul id="followingideaslist">
      </ul>
    </div>

    <div id="userideas">
      <h3>my ideas</h3>
      <ul id="userideaslist">
      </ul>
    </div>

    <div id="ideadetail">
      <h3>idea details</h3>
      <span id="ideatitle" style="font-weight:bold"></span>
      <p id="ideadescription"></p>
      <input id="bidamount"/>&nbsp;
    </div>

  </body>
</html>
