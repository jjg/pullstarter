<!doctype html>
  <head>
    <meta charset="utf-8">
    <title>Pullstarter</title>
    <meta name="description" content="My Parse App">
    <link rel="stylesheet" href="css/styles.css">
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.1.8.min.js"></script>
    <script>

      // init Parse
      Parse.initialize("sGF4JuqzcDyl4TDKKt3U7d3OdPNZG0FZ3TqTuJTr", "OXrMKIkKStgssmijppy8fbfutIvEvUaUOn0dHIwI");

      var Idea = Parse.Object.extend("Idea");

      $(document).ready(function() {
        loadIdeas();
      });

      function loadIdeas(){

        // load & display existing ideas
        var ideaQuery = new Parse.Query(Idea);
        ideaQuery.include("user");
        ideaQuery.find({
          success: function(results){

            // display list
            $.each(results, function(key, value){

              ideaQuery.get(value.id, {
                success: function(idea){
                  //console.log(idea.get("user"));
                  try{
                    $("#allideaslist").append("<li onclick='loadIdea(" + idea.id + ")'>" + idea.get("title") + " <i>by</i> " + idea.get("user").get("username") + "</li>");
                  } catch(ex) {
                    console.log(ex);
                  }
                  
                },
              error: function(object, error){
                  console.log(error);
                }
              });
            });
          },
          error: function(error){
            console.log("Error loading ideas: " + error.code + " " + error.message);
          }
        });
      }

      function loadIdea(ideaId){

        var ideaQuery = new Parse.Query(Idea);
        ideaQuery.get(ideaId, {
          success: function(idea){
            $("#ideatitle").html(idea.get("title"));
            $("#ideadescription").html(idea.get("description"));             
          },
          error: function(object, error){
              console.log(error);
            }
        });
      }

      function newIdea(){

        var user = Parse.User.current();

        if(user == null){
          alert("need to log in first");
        } else {
          var idea = new Idea();
          idea.set("title", $("#ideaTitle").val());
          idea.set("description", $("#ideaDescription").val());
          idea.set("user", user);

          idea.save(null,{
            success: function(object) {
              $("#allideaslist").append("<li onclick='loadIdea(" + idea.id + ")'>" + idea.get("title") + " <i>by</i> " + idea.get("user").get("username") + "</li>");
            },
            error: function(model, error) {
              console.log(error);
              alert("adding idea failed (darn!)");
            }
          });
        }
      }

      function register(){
        var user = new Parse.User();
        user.set("username", $("#username").val());
        user.set("password", $("#password").val());
        user.set("email", $("#email").val());

        user.signUp(null, {
          success: function(user){
            alert("signup sucessful!");
          },
          error: function(user, error){
            console.log(error);
            alert("signup failed!");
          }
        });
      }

      function login(){
        Parse.User.logIn($("#username").val(), $("#password").val(), {
          success: function(user){
            alert("logged-in sucessfully");
          },
          error: function(user, error){
            console.log(error);
            alert("login failed");
          }
        });
      }
    </script>
  </head>

  <body>

    <div id="login">
      <h3>login</h3>
      <ul>
        <li>username: <input id="username"/>
        <li>password: <input id="password"/>
        <li>email: <input id="email"/>
        <li><button onclick="register()">register</button>&nbsp;<button onclick="login()">login</botton>
      </ul>
    </div>

    <div id="newidea">
      Title: <input id="ideaTitle" type="text"><br>
      Description:<br><textarea id="ideaDescription"></textarea><br>
      <button onclick="newIdea()">add</button>
    </div>

    <div id="allideas">
      <h3>all ideas:</h3>
      <ul id="allideaslist">
      </ul>
    </div>

    <div id="idea">
      <h3 id="ideatitle"></h3>
      <p id="ideadescription"></p>
    </div>

  </body>
</html>
